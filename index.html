<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta http-equiv="x-ua-compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Disc Throw — BLE + 3D Viz (v1.8)</title>
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<style>
:root{--bg:#f7f8fb;--card:#fff;--text:#111;--muted:#666;--accent:#2563eb;--ok:#16a34a;--warn:#d97706;--err:#dc2626;--border:#e5e7eb}
*{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
header{padding:10px 14px;border-bottom:1px solid var(--border);background:#fff;position:sticky;top:0;z-index:2}
h1{margin:0;font-size:18px}
.wrap{padding:12px;display:grid;gap:12px;grid-template-columns:1fr}
@media (min-width:1100px){ .wrap{ grid-template-columns:420px 1fr; } }
@media (min-width:1400px){ .wrap{ grid-template-columns:430px 1fr; } }
.card{background:var(--card);border:1px solid var(--border);border-radius:10px;box-shadow:0 1px 0 rgba(0,0,0,.03)}
.card .pad{padding:14px}
.row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.btn{appearance:none;border:1px solid var(--border);background:#fff;color:var(--text);padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer;min-width:110px}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn.ok{background:var(--ok);color:#fff;border-color:var(--ok)}
.btn.warn{background:var(--warn);color:#fff;border-color:var(--warn)}
.btn.err{background:var(--err);color:#fff;border-color:var(--err)}
.kvs{display:grid;grid-template-columns:repeat(2,minmax(160px,1fr));gap:8px}
.kv{background:#fafafa;border:1px solid var(--border);border-radius:8px;padding:8px 10px}
.kv .k{font-size:12px;color:var(--muted)}
.kv .v{font-size:18px;font-weight:700}
.log{height:220px;overflow:auto;background:#0b1020;color:#dbeafe;border-radius:8px;padding:10px;font-size:13px;white-space:pre-wrap}
.badge{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted);background:#fff}
.footer{padding:10px 14px;color:var(--muted);font-size:12px}
#vizCard{ grid-column: 1 / -1; }
#viz{ height:70vh; min-height:560px; width:100%; }
.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="row" style="justify-content:space-between;gap:8px">
    <h1>Disc Throw — BLE + 3D Viz <span class="small">v1.8</span></h1>
    <div class="row"><span id="devName" class="badge">disconnected</span><button id="btnConnect" class="btn primary">Connect</button></div>
  </div>
</header>

<main class="wrap">

  <section class="card">
    <div class="pad">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0;font-size:16px">Summary</h2>
        <div class="row">
          <button id="btnRearm" class="btn ok" disabled>Rearm</button>
          <button id="btnSummary" class="btn" disabled>Summary</button>
          <button id="btnDump" class="btn" disabled>Dump</button>
          <button id="btnErase" class="btn err" disabled>Erase</button>
        </div>
      </div>
      <div style="height:8px"></div>
      <div class="kvs">
        <div class="kv"><div class="k">Apex</div><div class="v"><span id="apex">—</span> m</div></div>
        <div class="kv"><div class="k">Carry</div><div class="v"><span id="carry">—</span> m</div></div>
        <div class="kv"><div class="k">Release speed</div><div class="v"><span id="vrel">—</span> km/h</div></div>
        <div class="kv"><div class="k">Peak speed</div><div class="v"><span id="vpeak">—</span> km/h</div></div>
        <div class="kv"><div class="k">Spin @ release</div><div class="v"><span id="spin">—</span> rpm</div></div>
        <div class="kv"><div class="k">Hang time</div><div class="v"><span id="hang">—</span> s</div></div>
        <div class="kv"><div class="k">Hyzer @ release</div><div class="v"><span id="hyzer">—</span> °</div></div>
        <div class="kv"><div class="k">Nose @ release</div><div class="v"><span id="nose">—</span> °</div></div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="pad">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0;font-size:16px">Log</h2>
        <a id="btnSave" class="btn" download="throw.bin" style="display:none">Save dump</a>
      </div>
      <div style="height:8px"></div>
      <pre id="log" class="log"></pre>
      <label style="display:block;margin-top:6px"><input id="dbg" type="checkbox" checked> Debug chunks</label>
    </div>
  </section>

  <section id="vizCard" class="card">
    <div class="pad">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0;font-size:16px">3D Visualization</h2>
        <div class="row">
          <input id="fileBin" type="file" class="btn" accept=".bin" title="Load .bin to visualize">
          <button id="btnViz" class="btn">Visualize last dump</button>
          <a id="btnCSV" class="btn" download="throw.csv" style="display:none">CSV</a>
          <a id="btnPNG" class="btn" download="throw.png" style="display:none">PNG</a>
        </div>
      </div>
      <div class="small" id="vizStatus" style="margin-top:6px">Load a .bin or press “Visualize last dump”.</div>
      <div id="viz"></div>
    </div>
  </section>

</main>

<div class="footer">Use <b>Chrome/Edge</b> (Firefox doesn’t support Web Bluetooth). Page must be <b>HTTPS</b> or <b>localhost</b>.</div>

<script>
(function(){
"use strict";

/* ================= BASIC UI/STATE ================= */

var NUS_SERVICE='6e400001-b5a3-f393-e0a9-e50e24dcca9e';
var NUS_RX='6e400002-b5a3-f393-e0a9-e50e24dcca9e';
var NUS_TX='6e400003-b5a3-f393-e0a9-e50e24dcca9e';

var logEl=document.getElementById('log');
function log(msg,color){ var d=document.createElement('div'); d.textContent=msg; if(color) d.style.color=color; logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight; }
function dbg(){ return document.getElementById('dbg').checked; }
function hexPreview(b,m){ m=m||16; var n=Math.min(b.length,m); var s=''; for(var i=0;i<n;i++) s+=b[i].toString(16).padStart(2,'0')+' '; return s.trim()+(b.length>n?' …':''); }

var devNameEl=document.getElementById('devName');
var btnConnect=document.getElementById('btnConnect');
var btnRearm=document.getElementById('btnRearm');
var btnSummary=document.getElementById('btnSummary');
var btnDump=document.getElementById('btnDump');
var btnErase=document.getElementById('btnErase');
var btnSave=document.getElementById('btnSave');

var apexEl=document.getElementById('apex');
var carryEl=document.getElementById('carry');
var vrelEl=document.getElementById('vrel');
var vpeakEl=document.getElementById('vpeak');
var spinEl=document.getElementById('spin');
var hangEl=document.getElementById('hang');
var hyzerEl=document.getElementById('hyzer');
var noseEl=document.getElementById('nose');

var btnViz=document.getElementById('btnViz');
var fileBin=document.getElementById('fileBin');
var btnCSV=document.getElementById('btnCSV');
var btnPNG=document.getElementById('btnPNG');
var vizStatus=document.getElementById('vizStatus');
var vizDiv=document.getElementById('viz');

var device,server,rxChar,txChar,connected=false;
var userAskedDump=false, dumping=false, dumpExpected=0, dumpGot=0;
var dumpBuf=new Uint8Array(0), hdrBuf=new Uint8Array(0);
var td=new TextDecoder(); var textBuf='';

function setButtons(en){ btnRearm.disabled=btnSummary.disabled=btnDump.disabled=btnErase.disabled=!en; }
function uiConnected(name){ connected=true; devNameEl.textContent=name||'connected'; devNameEl.style.borderColor='#16a34a'; devNameEl.style.color='#16a34a'; btnConnect.textContent='Disconnect'; setButtons(true); }
function uiDisconnected(){ connected=false; devNameEl.textContent='disconnected'; devNameEl.style.borderColor='#e5e7eb'; devNameEl.style.color='#666'; btnConnect.textContent='Connect'; setButtons(false); btnSave.style.display='none'; }

/* ================= CONNECT/DISCONNECT ================= */
btnConnect.addEventListener('click', function(){
  try{
    if(!('bluetooth' in navigator)) { alert('Web Bluetooth not available.'); return; }
    if (location.protocol!=='https:' && location.hostname!=='localhost'){ alert('Use HTTPS or localhost.'); return; }
    if(!connected){ doConnect(); } else { doDisconnect(); }
  }catch(e){ log('Connect error: '+e,'#fca5a5'); }
});
function doConnect(){
  navigator.bluetooth.requestDevice({ filters:[{services:[NUS_SERVICE]}], optionalServices:[NUS_SERVICE]})
  .then(function(dev){ device=dev; device.addEventListener('gattserverdisconnected', onDisconnected); return device.gatt.connect(); })
  .then(function(s){ server=s; return server.getPrimaryService(NUS_SERVICE); })
  .then(function(svc){ return Promise.all([svc.getCharacteristic(NUS_RX), svc.getCharacteristic(NUS_TX)]); })
  .then(function(chars){ rxChar=chars[0]; txChar=chars[1]; return txChar.startNotifications(); })
  .then(function(){ txChar.addEventListener('characteristicvaluechanged', onTxNotify); uiConnected(device.name||'DiscThrower'); log('Connected to '+(device.name||'DiscThrower')); })
  .catch(function(e){ log('Connect error: '+e,'#fca5a5'); });
}
function doDisconnect(){ try{ if (device && device.gatt.connected) device.gatt.disconnect(); }catch(e){} uiDisconnected(); }
function onDisconnected(){ log('Disconnected','#fca5a5'); uiDisconnected(); }

/* ================= SEND ================= */
function sendCmd(s){
  if(!rxChar) return Promise.resolve();
  var enc=new TextEncoder(); var data=enc.encode(s+'\n'); var i=0;
  function step(){ if(i>=data.length) return Promise.resolve();
    var chunk=data.slice(i,i+200); i+=200;
    return rxChar.writeValueWithoutResponse(chunk).then(function(){ return new Promise(function(r){ setTimeout(r,6); });}).then(step);
  } return step();
}

/* ================= DUMP handling (two framers supported) ================= */
function appendDumpData(arr){
  var old=dumpBuf; dumpBuf=new Uint8Array(old.length+arr.length);
  dumpBuf.set(old,0); dumpBuf.set(arr,old.length);
  dumpGot = dumpBuf.length;
}
function finishDump(reason){
  dumping=false; userAskedDump=false; hdrBuf=new Uint8Array(0);
  var blob=new Blob([dumpBuf],{type:'application/octet-stream'});
  var url=URL.createObjectURL(blob);
  btnSave.href=url; btnSave.style.display='inline-block';
  var ts=new Date().toISOString().replace(/[:.]/g,'-');
  btnSave.download='throw_'+ts+'.bin';
  log('Dump finished ('+dumpBuf.length+'/'+dumpExpected+') ['+reason+']','#86efac');
  visualizeBytes(dumpBuf).catch(function(e){ vizStatus.textContent='Viz error: '+e; });
}
function findDl01Header(b){
  for(var i=0;i<=b.length-4;i++){ if (b[i]===0x44 && b[i+1]===0x4C && b[i+2]===0x30 && b[i+3]===0x31) return i; }
  return -1;
}

function onTxNotify(e){
  var v=new Uint8Array(e.target.value.buffer);
  if (dbg()) log('[notify] len='+v.length+' hex='+hexPreview(v),'#94a3b8');

  // --- If we're already collecting raw bytes via JSON preamble ---
  if (dumping && dumpExpected>0){
    appendDumpData(v);
    if (dumpBuf.length >= dumpExpected){
      var extra = dumpBuf.length - dumpExpected;
      if (extra>0){
        var tail = dumpBuf.slice(dumpExpected);
        dumpBuf = dumpBuf.slice(0,dumpExpected);
        finishDump('json_preamble_complete');
        textBuf += td.decode(tail,{stream:true});
      } else {
        finishDump('json_preamble_complete');
      }
    }
    return;
  }

  // --- DL01 fallback path (old firmware) ---
  if (userAskedDump){
    var concat=new Uint8Array(hdrBuf.length+v.length); concat.set(hdrBuf,0); concat.set(v,hdrBuf.length);
    var idx=findDl01Header(concat);
    if (idx!==-1 && concat.length>=idx+8){
      var off=idx+4;
      dumpExpected = concat[off] | (concat[off+1]<<8) | (concat[off+2]<<16) | (concat[off+3]<<24);
      dumpExpected += 0; // only body size expected in this path (we'll eat body after header)
      dumpBuf=new Uint8Array(0); dumping=true;
      log('DL01 header detected. Expecting '+dumpExpected+' body bytes','#fde68a');
      var rem=concat.slice(idx+8);
      if (rem.length) appendDumpData(rem);
      hdrBuf=new Uint8Array(0);
      if (dumpBuf.length >= dumpExpected) finishDump('dl01_exact');
      return;
    }
    // Keep last 7 bytes as rolling window
    hdrBuf = concat.slice(Math.max(0, concat.length-7));
  }

  // --- Decode as text (JSON / logs) ---
  textBuf += td.decode(v,{stream:true});
  processTextBuf();
}

function processTextBuf(){
  var pos;
  while ((pos = textBuf.indexOf('\n')) !== -1){
    var raw=textBuf.slice(0,pos); textBuf=textBuf.slice(pos+1);
    var line=raw.trim(); if(!line) continue;

    if (line.charAt(0)==='{' && line.charAt(line.length-1)==='}'){
      try{
        var safe=line.replace(/\bNaN\b/gi,'null').replace(/\b-?Infinity\b/gi,'null');
        var obj=JSON.parse(safe);

        if (obj && obj.type==='dump_begin' && typeof obj.bytes==='number'){
          // New robust path: we will now read exactly obj.bytes raw bytes
          dumping=true; dumpExpected=obj.bytes; dumpGot=0; dumpBuf=new Uint8Array(0); userAskedDump=false; hdrBuf=new Uint8Array(0);
          log('dump_begin: expecting '+dumpExpected+' bytes','#fde68a');
          continue;
        }
        if (obj && obj.type==='dump_done'){ log('dump_done from device.','#86efac'); continue; }

        if (obj && obj.type==='summary'){
          // Apply to UI tiles
          function fmt(x,d){ return (x===null||x===undefined||!isFinite(x))?'—':Number(x).toFixed(d); }
          apexEl.textContent  = fmt(obj.apex_m,2);
          // other fields aren’t in the summary yet; keep them as-is
          log('summary: samples='+obj.samples+' duration_ms='+obj.duration_ms,'#cbd5e1');
          continue;
        }

        log(line,'#cbd5e1'); // other JSON lines
        continue;
      }catch(err){ log('JSON parse error: '+err,'#fca5a5'); }
    } else {
      log(line);
    }
  }
}

/* ================= 3D Viz & CSV (unchanged from your v1.7) ================= */
/* ... the whole visualizeBytes() block from your page remains exactly the same ... */
/* For brevity here, I’m leaving your visualization code untouched. Use your v1.7 section as-is. */
/* Begin of copy from your original (unchanged except title version) */

var G=9.80665; function fmt(x,d){ return isFinite(x)?Number(x).toFixed(d):'—'; }
function stripHeaderIfAny(bytes){
  if (bytes.length>=8 && bytes[0]===0x44 && bytes[1]===0x4c && bytes[2]===0x30 && bytes[3]===0x31){
    var sz=bytes[4]|(bytes[5]<<8)|(bytes[6]<<16)|(bytes[7]<<24);
    return bytes.slice(8,8+sz);
  }
  return bytes;
}
function parseRecords(buf){
  var rec=4+2*6+4, n=Math.floor(buf.length/rec);
  var ms=new Uint32Array(n);
  var ax=new Float64Array(n), ay=new Float64Array(n), az=new Float64Array(n);
  var gx=new Float64Array(n), gy=new Float64Array(n), gz=new Float64Array(n);
  var p=new Float64Array(n);
  var dv=new DataView(buf.buffer,buf.byteOffset,n*rec); var o=0;
  for (var i=0;i<n;i++){
    ms[i]=dv.getUint32(o,true); o+=4;
    ax[i]=dv.getInt16(o,true)/100; o+=2; ay[i]=dv.getInt16(o,true)/100; o+=2; az[i]=dv.getInt16(o,true)/100; o+=2;
    gx[i]=dv.getInt16(o,true)/10;  o+=2; gy[i]=dv.getInt16(o,true)/10;  o+=2; gz[i]=dv.getInt16(o,true)/10;  o+=2;
    p[i]=dv.getFloat32(o,true); o+=4;
  }
  return {ms:ms,ax:ax,ay:ay,az:az,gx:gx,gy:gy,gz:gz,p:p};
}
/* (… keep your complementary filter + integration + Plotly code exactly as in your v1.7 …) */
/* To keep this message short, I’m not reprinting the long math/plot functions. Paste them from your file. */

function visualizeBytes(rawBytes){
  // your v1.7 implementation (unchanged) ...
  // (Use the exact block you already have; it works once bytes land correctly.)
}

/* ================= Buttons ================= */
btnRearm.addEventListener('click', function(){ sendCmd('REARM'); });
btnSummary.addEventListener('click', function(){ sendCmd('SUMMARY'); });
btnDump.addEventListener('click', function(){
  btnSave.style.display='none'; dumping=false; dumpExpected=0; dumpBuf=new Uint8Array(0); userAskedDump=true; hdrBuf=new Uint8Array(0);
  sendCmd('DUMP');
});
btnErase.addEventListener('click', function(){ sendCmd('ERASE'); });
btnViz.addEventListener('click', function(){ if (dumpBuf.length){ visualizeBytes(dumpBuf); } else { vizStatus.textContent='No dump in memory yet.'; }});
fileBin.addEventListener('change', function(e){ var f=e.target.files&&e.target.files[0]; if(!f) return; f.arrayBuffer().then(function(b){ visualizeBytes(new Uint8Array(b)); }); });

})();
</script>
</body>
</html>
