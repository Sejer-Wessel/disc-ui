<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Disc Throw — Minimal (v1.11m, auto-REARM)</title>
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<style>
:root{--bg:#f7f8fb;--card:#fff;--text:#111;--muted:#666;--accent:#2563eb;--ok:#16a34a;--err:#dc2626;--border:#e5e7eb}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.actionbar{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center;padding:10px 14px;z-index:5}
.badge{border:1px solid var(--border);border-radius:999px;padding:6px 12px;font-size:12px;color:#475569;background:#fff}
.btn{border:1px solid var(--border);border-radius:10px;padding:10px 16px;font-weight:700;cursor:pointer;background:#fff}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn:disabled{opacity:.55;cursor:not-allowed}
.wrap{padding:12px;display:grid;gap:12px;grid-template-columns:1fr}
@media (min-width:1100px){ .wrap{ grid-template-columns:420px 1fr; } }
.card{background:var(--card);border:1px solid var(--border);border-radius:10px;box-shadow:0 1px 0 rgba(0,0,0,.03)}
.card .pad{padding:14px}
.kvs{display:grid;grid-template-columns:repeat(2,minmax(160px,1fr));gap:8px}
.kv{background:#fafafa;border:1px solid var(--border);border-radius:8px;padding:8px 10px}
.kv .k{font-size:12px;color:var(--muted)}
.kv .v{font-size:18px;font-weight:700}
.log{height:240px;overflow:auto;background:#0b1020;color:#dbeafe;border-radius:8px;padding:10px;font-size:13px;white-space:pre-wrap}
.small{font-size:12px;color:var(--muted)}
#vizCard{grid-column:1/-1} #viz{height:70vh;min-height:560px;width:100%}
.progress{height:8px;background:#eef2ff;border-radius:999px;overflow:hidden;border:1px solid #e5e7eb}
.progress>div{height:100%;background:var(--accent);width:0%}
</style>
</head>
<body>
<div class="actionbar">
  <span id="chip" class="badge">Disconnected</span>
  <button id="btnConnect" class="btn primary">Connect</button>
  <div style="flex:1"></div>
  <button id="btnDumpViz" class="btn primary">Dump & Visualize</button>
</div>

<main class="wrap">
  <section class="card">
    <div class="pad">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 style="margin:0;font-size:16px">Summary</h2>
        <div class="small" id="summaryStatus">—</div>
      </div>
      <div style="height:8px"></div>
      <div class="kvs">
        <div class="kv"><div class="k">Apex</div><div class="v"><span id="apex">—</span> m</div></div>
        <div class="kv"><div class="k">Carry</div><div class="v"><span id="carry">—</span> m</div></div>
        <div class="kv"><div class="k">Release speed</div><div class="v"><span id="vrel">—</span> km/h</div></div>
        <div class="kv"><div class="k">Peak speed</div><div class="v"><span id="vpeak">—</span> km/h</div></div>
        <div class="kv"><div class="k">Spin @ release</div><div class="v"><span id="spin">—</span> rpm</div></div>
        <div class="kv"><div class="k">Hang time</div><div class="v"><span id="hang">—</span> s</div></div>
        <div class="kv"><div class="k">Hyzer @ release</div><div class="v"><span id="hyzer">—</span> °</div></div>
        <div class="kv"><div class="k">Nose @ release</div><div class="v"><span id="nose">—</span> °</div></div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="pad">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 style="margin:0;font-size:16px">Log</h2>
        <a id="btnSave" class="badge" download="throw.bin" style="display:none">Save dump</a>
      </div>
      <div style="height:8px"></div>
      <pre id="log" class="log"></pre>
      <div class="progress"><div id="prog"></div></div>
      <label class="small" style="display:block;margin-top:6px"><input id="dbg" type="checkbox" checked> Debug chunks</label>
    </div>
  </section>

  <section id="vizCard" class="card">
    <div class="pad">
      <h2 style="margin:0;font-size:16px">3D Visualization</h2>
      <div class="small" id="vizStatus" style="margin-top:6px">Press “Dump & Visualize”.</div>
      <div id="viz"></div>
    </div>
  </section>
</main>

<script>
(function(){
"use strict";

// ---------- BLE basics ----------
const NUS_SERVICE='6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const NUS_RX='6e400002-b5a3-f393-e0a9-e50e24dcca9e';
const NUS_TX='6e400003-b5a3-f393-e0a9-e50e24dcca9e';

const chip=document.getElementById('chip');
const btnConnect=document.getElementById('btnConnect');
const btnDumpViz=document.getElementById('btnDumpViz');
const logEl=document.getElementById('log');
const progBar=document.getElementById('prog');
const btnSave=document.getElementById('btnSave');
const vizStatus=document.getElementById('vizStatus');
const vizDiv=document.getElementById('viz');

const apexEl=document.getElementById('apex'), carryEl=document.getElementById('carry');
const vrelEl=document.getElementById('vrel'), vpeakEl=document.getElementById('vpeak');
const spinEl=document.getElementById('spin'), hangEl=document.getElementById('hang');
const hyzerEl=document.getElementById('hyzer'), noseEl=document.getElementById('nose');
const summaryStatus=document.getElementById('summaryStatus');

let device, server, rxChar, txChar, connected=false;
let dumping=false, userAskedDump=false, dumpExpected=0;
let dumpBuf=new Uint8Array(0), hdrBuf=new Uint8Array(0), useJsonFraming=false;
let textBuf='', lastSummaryMs=null;
const td=new TextDecoder();

function log(msg,color){ const d=document.createElement('div'); d.textContent=msg; if(color) d.style.color=color; logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight; }
function dbg(){ return document.getElementById('dbg').checked; }
function hexPreview(b,m){ m=m||16; const n=Math.min(b.length,m); let s=''; for(let i=0;i<n;i++) s+=b[i].toString(16).padStart(2,'0')+' '; return s.trim()+(b.length>n?' …':''); }
function setProgress(x){ progBar.style.width=(Math.max(0,Math.min(1,x))*100).toFixed(1)+'%'; }
function setState(s){
  if(s==='disconnected'){ chip.textContent='Disconnected'; chip.style.color='#475569'; btnConnect.textContent='Connect'; btnConnect.classList.add('primary'); }
  else if(s==='armed'){ chip.textContent='Armed (advertising)'; chip.style.color='#16a34a'; btnConnect.textContent='Disconnect'; btnConnect.classList.remove('primary'); }
  else if(s==='postble'){ chip.textContent='Ready to transfer'; chip.style.color='#16a34a'; btnConnect.textContent='Disconnect'; btnConnect.classList.remove('primary'); }
  else if(s==='logging'){ chip.textContent='Logging…'; chip.style.color='#d97706'; }
}
setState('disconnected');

// ---------- Connect with fallback ----------
btnConnect.onclick = async ()=>{
  if(connected){ try{ device.gatt.disconnect(); }catch(e){} connected=false; setState('disconnected'); log('Disconnected','#fca5a5'); return; }
  log('Opening Bluetooth chooser…');

  try{
    let dev=null;
    try{
      dev = await navigator.bluetooth.requestDevice({
        filters:[{services:[NUS_SERVICE]}],
        optionalServices:[NUS_SERVICE]
      });
    }catch(e){
      if(e.name==='NotFoundError'){
        log('No match with service filter; falling back to acceptAllDevices','#f59e0b');
        dev = await navigator.bluetooth.requestDevice({ acceptAllDevices:true, optionalServices:[NUS_SERVICE] });
      } else throw e;
    }

    device=dev; device.addEventListener('gattserverdisconnected',()=>{ connected=false; setState('disconnected'); log('Disconnected','#fca5a5'); });
    server=await device.gatt.connect();
    const svc=await server.getPrimaryService(NUS_SERVICE);
    [rxChar,txChar]=await Promise.all([svc.getCharacteristic(NUS_RX), svc.getCharacteristic(NUS_TX)]);
    await txChar.startNotifications();
    txChar.addEventListener('characteristicvaluechanged', onTxNotify);
    connected=true; setState('armed');
    log('Connected to '+(device.name||'DiscThrower'));
  }catch(e){ log('Connect error: '+e,'#fca5a5'); }
};

// ---------- Dump ----------
btnDumpViz.onclick = ()=>{
  if(!connected){ log('Not connected. Click Connect first.','#fca5a5'); return; }
  btnSave.style.display='none';
  dumping=false; userAskedDump=true; useJsonFraming=false; dumpExpected=0; dumpBuf=new Uint8Array(0); hdrBuf=new Uint8Array(0); setProgress(0);
  sendCmd('DUMP');
};

function sendCmd(s){
  if(!rxChar) return;
  const enc=new TextEncoder(); const data=enc.encode(s+'\n');
  let i=0; (function step(){ if(i>=data.length) return;
    const chunk=data.slice(i,i+200); i+=200;
    rxChar.writeValueWithoutResponse(chunk).then(()=>new Promise(r=>setTimeout(r,6))).then(step);
  })();
}

function appendDumpData(arr){
  const old=dumpBuf; dumpBuf=new Uint8Array(old.length+arr.length); dumpBuf.set(old,0); dumpBuf.set(arr,old.length);
  if(dumpExpected>0) setProgress(dumpBuf.length/dumpExpected);
}

function finishDump(reason){
  dumping=false; userAskedDump=false; setProgress(1);

  // Trim to DL01 payload if present
  const idx=findDl01Header(dumpBuf);
  if (idx!==-1 && dumpBuf.length>=idx+8){
    const off=idx+4, sz=dumpBuf[off]|(dumpBuf[off+1]<<8)|(dumpBuf[off+2]<<16)|(dumpBuf[off+3]<<24);
    const need=idx+8+sz; if (dumpBuf.length>=need) dumpBuf=dumpBuf.slice(idx,need); dumpExpected=need;
  }

  const blob=new Blob([dumpBuf],{type:'application/octet-stream'});
  const url=URL.createObjectURL(blob);
  btnSave.href=url; btnSave.style.display='inline-block';
  btnSave.download='throw_'+new Date().toISOString().replace(/[:.]/g,'-')+'.bin';
  log('Dump finished ('+dumpBuf.length+'/'+dumpExpected+') ['+reason+']','#86efac');

  // ✅ Auto-REARM the device so it’s ready for the next throw
  setTimeout(()=>{
    log('Auto-REARM…');
    sendCmd('REARM');
  }, 350);

  setState('postble'); // UI text; connection stays up
  visualizeBytes(dumpBuf).catch(e=>{ vizStatus.textContent='Viz error: '+e; });
}

function findDl01Header(b){ for(let i=0;i<=b.length-4;i++){ if(b[i]===0x44&&b[i+1]===0x4C&&b[i+2]===0x30&&b[i+3]===0x31) return i; } return -1; }

function onTxNotify(e){
  const v=new Uint8Array(e.target.value.buffer);
  if(dbg()) log('[notify] len='+v.length+' hex='+hexPreview(v),'#94a3b8');

  // If we're in JSON-framed mode, raw bytes are the dump body
  if(dumping && useJsonFraming){
    appendDumpData(v);
    if(dumpExpected>0 && dumpBuf.length>=dumpExpected){
      const extra=dumpBuf.length-dumpExpected;
      if(extra>0){ const tail=dumpBuf.slice(dumpExpected); dumpBuf=dumpBuf.slice(0,dumpExpected); finishDump('json_exact'); textBuf+=td.decode(tail,{stream:true}); }
      else finishDump('json_exact');
    }
    return;
  }

  // Legacy DL01 auto-detect while waiting for header
  if(userAskedDump && !useJsonFraming){
    const concat=new Uint8Array(hdrBuf.length+v.length); concat.set(hdrBuf,0); concat.set(v,hdrBuf.length);
    const idx=findDl01Header(concat);
    if(idx!==-1 && concat.length>=idx+8){
      const off=idx+4; const body=concat[off]|(concat[off+1]<<8)|(concat[off+2]<<16)|(concat[off+3]<<24);
      dumpExpected=8+body; dumpBuf=concat.slice(idx); dumping=true; userAskedDump=false; hdrBuf=new Uint8Array(0); log('DL01 header detected. Expecting '+dumpExpected+' bytes','#fde68a');
      if(dumpBuf.length>=dumpExpected) finishDump('dl01_exact');
      return;
    }
    hdrBuf=concat.slice(Math.max(0,concat.length-7));
  }

  // Otherwise treat as JSON lines
  textBuf+=td.decode(v,{stream:true});
  processTextBuf();
}

function processTextBuf(){
  let pos;
  while((pos=textBuf.indexOf('\n'))!==-1){
    const raw=textBuf.slice(0,pos); textBuf=textBuf.slice(pos+1);
    const line=raw.trim(); if(!line) continue;

    if(line[0]==='{' && line[line.length-1]==='}'){
      try{
        const obj=JSON.parse(line.replace(/\bNaN\b/gi,'null').replace(/\b-?Infinity\b/gi,'null'));

        if(obj.type==='dump_begin' && typeof obj.bytes==='number'){
          dumping=true; useJsonFraming=true; dumpExpected=obj.bytes; setProgress(0); log('dump_begin '+dumpExpected+' bytes','#fde68a'); continue;
        }
        if(obj.type==='dump_done'){
          log('dump_done','#86efac');
          if (dumping) finishDump('dump_done_signal'); // finalize even if size match hasn’t triggered yet
          continue;
        }
        if(obj.type==='summary'){
          lastSummaryMs = Number(obj.duration_ms)||null;
          summaryStatus.textContent='Samples '+obj.samples+' · duration '+obj.duration_ms+' ms';
          if(isFinite(obj.apex_m)) apexEl.textContent=Number(obj.apex_m).toFixed(2);
          continue;
        }
        if(obj.ok==='rearmed'){ log('Device rearmed','#86efac'); setState('armed'); continue; }

        log(line,'#cbd5e1');
      }catch(err){ log('JSON parse error: '+err,'#fca5a5'); }
    } else log(line);
  }
}

// ---------- Viz (guards for bad data) ----------
const G=9.80665;
function fmt(x,d){ return isFinite(x)?Number(x).toFixed(d):'—'; }

function stripHeaderIfAny(bytes){
  if(bytes.length>=8 && bytes[0]===0x44 && bytes[1]===0x4c && bytes[2]===0x30 && bytes[3]===0x31){
    const sz=bytes[4]|(bytes[5]<<8)|(bytes[6]<<16)|(bytes[7]<<24);
    return bytes.slice(8,8+sz);
  }
  return bytes;
}
function parseRecords(buf){
  const rec=4+2*6+4, n=Math.floor(buf.length/rec);
  const ms=new Uint32Array(n);
  const ax=new Float64Array(n), ay=new Float64Array(n), az=new Float64Array(n);
  const gx=new Float64Array(n), gy=new Float64Array(n), gz=new Float64Array(n);
  const p =new Float64Array(n);
  const dv=new DataView(buf.buffer, buf.byteOffset, n*rec);
  let o=0;
  for(let i=0;i<n;i++){
    ms[i]=dv.getUint32(o,true); o+=4;
    ax[i]=dv.getInt16(o,true)/100; o+=2; ay[i]=dv.getInt16(o,true)/100; o+=2; az[i]=dv.getInt16(o,true)/100; o+=2;
    gx[i]=dv.getInt16(o,true)/10;  o+=2; gy[i]=dv.getInt16(o,true)/10;  o+=2; gz[i]=dv.getInt16(o,true)/10;  o+=2;
    p[i]=dv.getFloat32(o,true); o+=4;
  }
  return {ms,ax,ay,az,gx,gy,gz,p};
}
function normalizeTime(msU32){
  const MAX=0x100000000>>>0;
  const n=msU32.length; const t=new Array(n);
  let base=msU32[0]>>>0, prev=base>>>0, off=0;
  for(let i=0;i<n;i++){
    const cur=msU32[i]>>>0;
    if(cur<prev) off+=MAX;
    t[i]=(cur+off-base)/1000;
    prev=cur;
  }
  for(let i=1;i<n;i++){ const dt=t[i]-t[i-1]; if(dt<0.001||dt>0.1){ t[i]=t[i-1]+Math.max(0.001, Math.min(0.05, dt)); } }
  return t;
}
function complementaryRPY(ax,ay,az,gx,gy,gz,dt,tau){
  const n=dt.length, roll=new Float64Array(n), pitch=new Float64Array(n), yaw=new Float64Array(n);
  const gxr=new Float64Array(n), gyr=new Float64Array(n), gzr=new Float64Array(n);
  for(let i=0;i<n;i++){ gxr[i]=gx[i]*Math.PI/180; gyr[i]=gy[i]*Math.PI/180; gzr[i]=gz[i]*Math.PI/180; }
  roll[0]=Math.atan2(ay[0],az[0]); pitch[0]=Math.atan2(-ax[0], Math.hypot(ay[0],az[0]));
  for(let i=1;i<n;i++){
    const a=tau/(tau+dt[i]);
    const roll_g=roll[i-1]+gxr[i]*dt[i], pitch_g=pitch[i-1]+gyr[i]*dt[i];
    yaw[i]=yaw[i-1]+gzr[i]*dt[i];
    const roll_a=Math.atan2(ay[i],az[i]); const pitch_a=Math.atan2(-ax[i], Math.hypot(ay[i],az[i]));
    roll[i]=a*roll_g+(1-a)*roll_a; pitch[i]=a*pitch_g+(1-a)*pitch_a;
  }
  return {roll,pitch,yaw};
}
function rotationMats(roll,pitch,yaw){
  const n=roll.length, R=new Array(n);
  for(let i=0;i<n;i++){
    const cr=Math.cos(roll[i]), sr=Math.sin(roll[i]);
    const cp=Math.cos(pitch[i]), sp=Math.sin(pitch[i]);
    const cy=Math.cos(yaw[i]), sy=Math.sin(yaw[i]);
    R[i]=[[cy*cp,cy*sp*sr - sy*cr,cy*sp*cr + sy*sr],[sy*cp,sy*sp*sr + cy*cr,sy*sp*cr - cy*sr],[-sp,cp*sr,cp*cr]];
  }
  return R;
}
function mulMV(M,v){ return [ M[0][0]*v[0]+M[0][1]*v[1]+M[0][2]*v[2], M[1][0]*v[0]+M[1][1]*v[1]+M[1][2]*v[2], M[2][0]*v[0]+M[2][1]*v[1]+M[2][2]*v[2] ]; }
function detectMotion(a_ms2,g_dps){
  const n=a_ms2.length, mask=new Array(n);
  for(let i=0;i<n;i++){
    const aN=Math.hypot(a_ms2[i][0],a_ms2[i][1],a_ms2[i][2])/9.80665;
    const gN=Math.hypot(g_dps[i][0],g_dps[i][1],g_dps[i][2]);
    mask[i]=(gN>50)||Math.abs(aN-1)>0.15;
  }
  const out=new Array(n);
  for(let i=0;i<n;i++){ let s=0; for(let j=-4;j<=4;j++){ const x=i+j; if(x>=0&&x<n) s+=mask[x]?1:0; } out[i]=s>4; }
  return out;
}
function integrateWithEndZero(a,t,move){
  const n=t.length, v=new Array(n), p=new Array(n);
  for(let i=0;i<n;i++){ v[i]=[0,0,0]; p[i]=[0,0,0]; }
  const dt=new Array(n); dt[0]=0; for(let i=1;i<n;i++) dt[i]=Math.max(0.001,Math.min(0.05,t[i]-t[i-1]));
  for(let i=1;i<n;i++){ for(let j=0;j<3;j++) v[i][j]=v[i-1][j]+a[i][j]*dt[i]; }
  let any=false; for(let i=0;i<move.length;i++) if(move[i]){ any=true; break; }
  if(any){
    const i0=move.indexOf(true); const i1=move.length-1 - move.slice().reverse().indexOf(true);
    const T=Math.max(t[i1]-t[i0],1e-6); const drift=[ v[i1][0]/T, v[i1][1]/T, v[i1][2]/T ];
    for(let i=i0;i<=i1;i++){ const s=t[i]-t[i0]; for(let j=0;j<3;j++) v[i][j]-=s*drift[j]; }
    for(let i=1;i<n;i++){ for(let j=0;j<3;j++) p[i][j]=p[i-1][j]+v[i][j]*dt[i]; }
    const o=[p[i0][0],p[i0][1],p[i0][2]]; for(let i=0;i<n;i++){ for(let j=0;j<3;j++) p[i][j]-=o[j]; }
  }
  return {v,p};
}
function yawMatrix(deg){ const r=deg*Math.PI/180,c=Math.cos(r),s=Math.sin(r); return [[c,-s,0],[s,c,0],[0,0,1]]; }
function mulYaw(M,v){ return [ M[0][0]*v[0]+M[0][1]*v[1], M[1][0]*v[0]+M[1][1]*v[1], v[2] ]; }

function visualizeBytes(rawBytes){
  vizStatus.textContent='Parsing…';
  const payload=stripHeaderIfAny(new Uint8Array(rawBytes));
  const rec=parseRecords(payload);
  if(!rec.ms.length){ vizStatus.textContent='No samples.'; return; }

  const t = normalizeTime(rec.ms);
  const dt=new Array(t.length); dt[0]=0; for(let i=1;i<t.length;i++) dt[i]=Math.max(0.001,Math.min(0.05,t[i]-t[i-1]));

  const rpy=complementaryRPY(rec.ax,rec.ay,rec.az,rec.gx,rec.gy,rec.gz,dt,0.5);
  const R=rotationMats(rpy.roll,rpy.pitch,rpy.yaw);

  const aBody=new Array(rec.ax.length); for(let i=0;i<aBody.length;i++) aBody[i]=[rec.ax[i],rec.ay[i],rec.az[i]];
  const aWorld=new Array(aBody.length); for(let i=0;i<aWorld.length;i++) aWorld[i]=mulMV(R[i],aBody[i]);
  const aLin=new Array(aWorld.length); for(let i=0;i<aLin.length;i++) aLin[i]=[aWorld[i][0],aWorld[i][1],aWorld[i][2]-9.80665];

  const g3=new Array(rec.gx.length); for(let i=0;i<g3.length;i++) g3[i]=[rec.gx[i],rec.gy[i],rec.gz[i]];
  const move=detectMotion(aBody,g3);
  const ip=integrateWithEndZero(aLin,t,move); const v=ip.v, p=ip.p;

  const speed=new Array(v.length); for(let i=0;i<speed.length;i++) speed[i]=Math.hypot(v[i][0],v[i][1],v[i][2])+1e-12;
  const ir = (function pickReleaseIndex(){
    const n=t.length; const s=new Array(n);
    const dtAvg=(t[n-1]-t[0])/Math.max(1,n-1)||0.01; const w=Math.max(1,Math.round(0.05/dtAvg));
    for(let i=0;i<n;i++){ let sum=0,c=0; for(let j=-w;j<=w;j++){ const k=i+j; if(k>=0&&k<n){ sum+=speed[k]; c++; } } s[i]=sum/Math.max(1,c); }
    const endT=t[0]+Math.min(0.30,t[t.length-1]-t[0]); let endI=n-1; for(let i=0;i<n;i++) if(t[i]>=endT){ endI=i; break; }
    let mx=-1, mi=0; for(let i=0;i<=endI;i++) if(s[i]>mx){ mx=s[i]; mi=i; } return mi;
  })();

  // Pressure → altitude with guards
  function altFromPa(pPa,p0Pa){
    if(!isFinite(pPa) || pPa<50000 || pPa>110000) return NaN;
    return 44330*(1.0 - Math.pow((pPa/100)/(p0Pa/100), 1/5.255));
  }
  const validIdx=[]; for(let i=0;i<rec.p.length;i++){ if(isFinite(rec.p[i]) && rec.p[i]>50000 && rec.p[i]<110000) validIdx.push(i); }
  let p0Pa=101325; if(validIdx.length){ const firstSecond = validIdx.filter(i=>t[i]-t[0]<1.0).map(i=>rec.p[i]); firstSecond.sort((a,b)=>a-b); p0Pa = firstSecond[Math.floor(firstSecond.length/2)] || firstSecond[0] || 101325; }
  const alt=new Array(rec.p.length); for(let i=0;i<alt.length;i++) alt[i]=altFromPa(rec.p[i],p0Pa);

  const theta=Math.atan2(v[ir][1],v[ir][0])*180/Math.PI; const Q=yawMatrix(-theta);
  const pView=new Array(p.length); for(let i=0;i<p.length;i++) pView[i]=mulYaw(Q,p[i]);

  function toKmh(s){ return s*3.6; }
  let peakSp=0; for(let i=0;i<speed.length;i++) if(speed[i]>peakSp) peakSp=speed[i];
  const dtAvg=(t[t.length-1]-t[0])/Math.max(1,t.length-1)||0.01;
  const w=Math.max(1,Math.round(0.05/dtAvg));
  const j0=Math.max(0,ir-w), j1=Math.min(speed.length-1, ir+w);
  let releaseSp=0; for(let i=j0;i<=j1;i++) releaseSp+=speed[i]; releaseSp/=Math.max(1,(j1-j0+1));
  let gmag=0; for(let i=j0;i<=j1;i++) gmag+=Math.hypot(rec.gx[i],rec.gy[i],rec.gz[i]); gmag/=Math.max(1,(j1-j0+1));
  const spinRpm=gmag/6;
  const hyzerDeg=-rpy.roll[ir]*180/Math.PI, noseDeg=rpy.pitch[ir]*180/Math.PI;
  const dx=p[p.length-1][0]-p[0][0], dy=p[p.length-1][1]-p[0][1];
  let carry=Math.hypot(dx,dy); if(!isFinite(carry) || carry>500) carry=NaN;

  let mx=-Infinity; for(let i=0;i<alt.length;i++) if(isFinite(alt[i]) && alt[i]>mx) mx=alt[i];
  let apx=isFinite(mx)&&isFinite(alt[0]) ? mx-alt[0] : NaN; if(apx>100) apx=NaN;

  let hang=t[t.length-1]-t[0];
  if(lastSummaryMs) hang=Math.min(hang, lastSummaryMs/1000 + 0.2);
  if(hang<0 || hang>60) hang=NaN;

  apexEl.textContent=fmt(apx,2);
  carryEl.textContent=fmt(carry,1);
  vrelEl.textContent=fmt(toKmh(releaseSp),1);
  vpeakEl.textContent=fmt(toKmh(peakSp),1);
  spinEl.textContent=fmt(spinRpm,0);
  hangEl.textContent=fmt(hang,2);
  hyzerEl.textContent=fmt(hyzerDeg,1);
  noseEl.textContent=fmt(noseDeg,1);

  vizStatus.textContent='Rendering…';
  const xs=pView.map(v=>v[0]), ys=pView.map(v=>v[1]), zs=pView.map(v=>v[2]);
  function rng(a){ let lo=Infinity, hi=-Infinity; for(const x of a){ if(x<lo) lo=x; if(x>hi) hi=x; } return isFinite(lo)&&isFinite(hi)&&hi>lo?[lo,hi]:[-1,1]; }

  Plotly.newPlot(vizDiv,[
    {type:'scatter3d',mode:'lines',x:xs,y:ys,z:zs,line:{width:6},name:'This throw'},
    {type:'scatter3d',mode:'markers',x:[xs[ir]],y:[ys[ir]],z:[zs[ir]],marker:{size:6,symbol:'diamond'},name:'Release'},
    {type:'scatter3d',mode:'markers',x:[xs[xs.length-1]],y:[ys[ys.length-1]],z:[zs[zs.length-1]],marker:{size:6,symbol:'x'},name:'End'}
  ],{scene:{xaxis:{title:'X (m)',range:rng(xs)},yaxis:{title:'Y (m)',range:rng(ys)},zaxis:{title:'Z (m)',range:rng(zs)},aspectmode:'data'},
      margin:{l:0,r:0,t:30,b:0},
      title:'Flight — release '+fmt(toKmh(releaseSp),1)+' km/h · peak '+fmt(toKmh(peakSp),1)+' km/h · carry '+fmt(carry,1)+' m · apex '+fmt(apx,1)+' m'
    },{responsive:true}).then(()=> vizStatus.textContent='Done.');
}

})();
</script>
</body>
</html>
