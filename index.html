<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta http-equiv="x-ua-compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Disc Throw — BLE + 3D Viz (v1.9)</title>
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<style>
:root{
  --bg:#f7f8fb;--card:#fff;--text:#111;--muted:#666;--accent:#2563eb;
  --ok:#16a34a;--warn:#d97706;--err:#dc2626;--border:#e5e7eb
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

/* ===== Action Bar ===== */
.actionbar{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:10px;padding:10px 14px}
.badge{border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:12px;color:#475569;background:#fff}
.split{display:inline-flex;border:1px solid var(--border);border-radius:10px;overflow:hidden}
.split > button{border:0;background:#fff;padding:10px 14px;font-weight:600;cursor:pointer;min-width:120px}
.split > button.primary{background:var(--accent);color:#fff}
.split > button:disabled{opacity:.5;cursor:not-allowed}
.menu{position:relative}
.menu > button::after{content:"▾";margin-left:6px}
.menu ul{display:none;position:absolute;right:0;top:calc(100% + 6px);min-width:200px;background:#fff;border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:6px;margin:0;list-style:none;z-index:20}
.menu ul li{margin:0}
.menu ul button{width:100%;text-align:left;background:transparent;border:0;padding:10px 12px;cursor:pointer}
.menu ul button.danger{color:var(--err)}
.menu.open ul{display:block}
.grow{flex:1}

/* ===== Main layout ===== */
.wrap{padding:12px;display:grid;gap:12px;grid-template-columns:1fr}
@media (min-width:1100px){ .wrap{ grid-template-columns:420px 1fr; } }
@media (min-width:1400px){ .wrap{ grid-template-columns:430px 1fr; } }

.card{background:var(--card);border:1px solid var(--border);border-radius:10px;box-shadow:0 1px 0 rgba(0,0,0,.03)}
.card .pad{padding:14px}

.kvs{display:grid;grid-template-columns:repeat(2,minmax(160px,1fr));gap:8px}
.kv{background:#fafafa;border:1px solid var(--border);border-radius:8px;padding:8px 10px}
.kv .k{font-size:12px;color:var(--muted)}
.kv .v{font-size:18px;font-weight:700}

.log{height:230px;overflow:auto;background:#0b1020;color:#dbeafe;border-radius:8px;padding:10px;font-size:13px;white-space:pre-wrap}
.small{font-size:12px;color:var(--muted)}
.footer{padding:10px 14px;color:var(--muted);font-size:12px}

/* Visualizer full-width */
#vizCard{ grid-column: 1 / -1; }
#viz{ height:70vh; min-height:560px; width:100%; }

/* Progress */
.progress{height:8px;background:#eef2ff;border-radius:999px;overflow:hidden;border:1px solid #e5e7eb}
.progress > div{height:100%;background:var(--accent);width:0%}
</style>
</head>
<body>

<!-- ===== ACTION BAR ===== -->
<div class="actionbar">
  <span id="chip" class="badge">Disconnected</span>
  <button id="btnPrimary" class="split-btn primary" style="border:1px solid var(--border);border-radius:10px;padding:10px 14px;font-weight:700">Connect</button>

  <div class="grow"></div>

  <!-- Data actions -->
  <div class="split">
    <button id="btnDumpViz" class="primary" title="Download throw from device and visualize">Dump & Visualize</button>
    <div class="menu" id="menuData">
      <button id="btnDataMenu" aria-haspopup="true" aria-expanded="false">More</button>
      <ul role="menu" aria-label="Data actions">
        <li><button id="miSummary">Summary</button></li>
        <li><button id="miDumpOnly">Dump only</button></li>
        <li><button id="miErase" class="danger">Erase log</button></li>
        <li><button id="miRearm">Rearm device</button></li>
        <li><button id="miAutosave">Auto-save: <span id="autosaveState">On</span></button></li>
      </ul>
    </div>
  </div>

  <!-- Viz actions -->
  <div class="split">
    <button id="btnVizLast" title="Render the last dump kept in memory">Visualize last</button>
    <div class="menu" id="menuViz">
      <button id="btnVizMenu" aria-haspopup="true" aria-expanded="false">More</button>
      <ul role="menu" aria-label="Visualization">
        <li><button id="miLoadBin">Load .bin</button></li>
        <li><button id="miCSV">Export CSV</button></li>
        <li><button id="miPNG">Export PNG</button></li>
      </ul>
    </div>
  </div>
</div>

<main class="wrap">

  <!-- Summary -->
  <section class="card">
    <div class="pad">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 style="margin:0;font-size:16px">Summary</h2>
        <div class="small" id="summaryStatus">—</div>
      </div>
      <div style="height:8px"></div>
      <div class="kvs">
        <div class="kv"><div class="k">Apex</div><div class="v"><span id="apex">—</span> m</div></div>
        <div class="kv"><div class="k">Carry</div><div class="v"><span id="carry">—</span> m</div></div>
        <div class="kv"><div class="k">Release speed</div><div class="v"><span id="vrel">—</span> km/h</div></div>
        <div class="kv"><div class="k">Peak speed</div><div class="v"><span id="vpeak">—</span> km/h</div></div>
        <div class="kv"><div class="k">Spin @ release</div><div class="v"><span id="spin">—</span> rpm</div></div>
        <div class="kv"><div class="k">Hang time</div><div class="v"><span id="hang">—</span> s</div></div>
        <div class="kv"><div class="k">Hyzer @ release</div><div class="v"><span id="hyzer">—</span> °</div></div>
        <div class="kv"><div class="k">Nose @ release</div><div class="v"><span id="nose">—</span> °</div></div>
      </div>
    </div>
  </section>

  <!-- Log -->
  <section class="card">
    <div class="pad">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 style="margin:0;font-size:16px">Log</h2>
        <a id="btnSave" class="badge" download="throw.bin" style="display:none">Save dump</a>
      </div>
      <div style="height:8px"></div>
      <pre id="log" class="log"></pre>
      <div class="progress" title="Dump progress"><div id="prog"></div></div>
      <label style="display:block;margin-top:6px"><input id="dbg" type="checkbox" checked> Debug chunks</label>
    </div>
  </section>

  <!-- Visualization -->
  <section id="vizCard" class="card">
    <div class="pad">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 style="margin:0;font-size:16px">3D Visualization</h2>
        <div class="row">
          <input id="fileBin" type="file" class="badge" accept=".bin" title="Load .bin">
          <a id="btnCSV" class="badge" download="throw.csv" style="display:none">CSV</a>
          <a id="btnPNG" class="badge" download="throw.png" style="display:none">PNG</a>
        </div>
      </div>
      <div class="small" id="vizStatus" style="margin-top:6px">Load a .bin or use “Dump & Visualize”.</div>
      <div id="viz"></div>
    </div>
  </section>

</main>

<div class="footer">
  Use <b>Chrome/Edge</b> (Firefox doesn’t support Web Bluetooth). Page must be <b>HTTPS</b> or <b>localhost</b>.
</div>

<script>
(function(){
  "use strict";

  /* ================= BASIC UI/STATE ================= */

  var NUS_SERVICE='6e400001-b5a3-f393-e0a9-e50e24dcca9e';
  var NUS_RX='6e400002-b5a3-f393-e0a9-e50e24dcca9e';
  var NUS_TX='6e400003-b5a3-f393-e0a9-e50e24dcca9e';

  var logEl = document.getElementById('log');
  var chip = document.getElementById('chip');
  var btnPrimary = document.getElementById('btnPrimary');

  var btnDumpViz = document.getElementById('btnDumpViz');
  var btnDataMenu = document.getElementById('btnDataMenu');
  var btnVizLast = document.getElementById('btnVizLast');
  var btnVizMenu = document.getElementById('btnVizMenu');

  var menuData = document.getElementById('menuData');
  var menuViz = document.getElementById('menuViz');

  var miSummary = document.getElementById('miSummary');
  var miDumpOnly = document.getElementById('miDumpOnly');
  var miErase = document.getElementById('miErase');
  var miRearm = document.getElementById('miRearm');
  var miAutosave = document.getElementById('miAutosave');
  var autosaveStateEl = document.getElementById('autosaveState');

  var btnSave = document.getElementById('btnSave');
  var progBar = document.getElementById('prog');

  var apexEl = document.getElementById('apex');
  var carryEl= document.getElementById('carry');
  var vrelEl = document.getElementById('vrel');
  var vpeakEl= document.getElementById('vpeak');
  var spinEl = document.getElementById('spin');
  var hangEl = document.getElementById('hang');
  var hyzerEl= document.getElementById('hyzer');
  var noseEl = document.getElementById('nose');
  var summaryStatus = document.getElementById('summaryStatus');

  var btnCSV = document.getElementById('btnCSV');
  var btnPNG = document.getElementById('btnPNG');
  var fileBin = document.getElementById('fileBin');
  var vizStatus = document.getElementById('vizStatus');
  var vizDiv = document.getElementById('viz');

  var device, server, rxChar, txChar, connected=false;
  var userAskedDump=false, dumping=false, dumpExpected=0, dumpGot=0, dumpAutoViz=true;
  var dumpBuf=new Uint8Array(0), hdrBuf=new Uint8Array(0);
  var td=new TextDecoder(); var textBuf='';
  var autoSave=true;

  function log(msg,color){
    var d=document.createElement('div'); d.textContent=msg; if(color) d.style.color=color;
    logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight;
  }
  function dbg(){ return document.getElementById('dbg').checked; }
  function hexPreview(b,m){ m=m||16; var n=Math.min(b.length,m); var s=''; for(var i=0;i<n;i++){ s+=b[i].toString(16).padStart(2,'0')+' '; } return s.trim()+(b.length>n?' …':''); }
  function setProgress(x){ progBar.style.width=(Math.max(0,Math.min(1,x))*100).toFixed(1)+'%'; }

  // menus
  function toggleMenu(el){ el.classList.toggle('open'); el.querySelector('button').setAttribute('aria-expanded', el.classList.contains('open')); }
  btnDataMenu.onclick = ()=>toggleMenu(menuData);
  btnVizMenu.onclick  = ()=>toggleMenu(menuViz);
  window.addEventListener('click', e=>{
    document.querySelectorAll('.menu.open').forEach(m=>{ if(!m.contains(e.target)) { m.classList.remove('open'); m.querySelector('button').setAttribute('aria-expanded','false'); }});
  });

  // UI state
  function setState(s){
    if (s==='disconnected'){
      chip.textContent='Disconnected'; chip.style.color='#475569';
      btnPrimary.textContent='Connect';
      btnPrimary.onclick=doConnect;
      btnPrimary.disabled=false;
    } else if (s==='armed'){
      chip.textContent='Armed (advertising)'; chip.style.color='#16a34a';
      btnPrimary.textContent='Disconnect'; btnPrimary.onclick=doDisconnect; btnPrimary.disabled=false;
    } else if (s==='logging'){
      chip.textContent='Logging…'; chip.style.color='#d97706';
      btnPrimary.textContent='Logging…'; btnPrimary.disabled=true;
    } else { // postble
      chip.textContent='Ready to transfer'; chip.style.color='#16a34a';
      btnPrimary.textContent='Rearm';
      btnPrimary.onclick=()=>sendCmd('REARM');
      btnPrimary.disabled=false;
    }
  }
  window.setDiscUIState = setState; // expose if you want to call it

  /* ================= CONNECT/DISCONNECT ================= */
  function doConnect(){
    log('Opening Bluetooth chooser…');
    navigator.bluetooth.requestDevice({ filters:[{ services:[NUS_SERVICE] }], optionalServices:[NUS_SERVICE] })
    .then(dev=>{ device=dev; device.addEventListener('gattserverdisconnected', onDisconnected); return device.gatt.connect(); })
    .then(s=>{ server=s; return server.getPrimaryService(NUS_SERVICE); })
    .then(svc=>Promise.all([svc.getCharacteristic(NUS_RX), svc.getCharacteristic(NUS_TX)]))
    .then(chars=>{
      rxChar=chars[0]; txChar=chars[1];
      return txChar.startNotifications();
    })
    .then(()=>{
      txChar.addEventListener('characteristicvaluechanged', onTxNotify);
      connected=true; setState('armed');
      log('Connected to ' + (device.name || 'DiscThrower'));
    })
    .catch(e=>{ log('Connect error: ' + e, '#fca5a5'); });
  }
  function doDisconnect(){
    try{ if (device && device.gatt.connected) device.gatt.disconnect(); }catch(e){}
    uiDisconnected();
  }
  function uiDisconnected(){
    connected=false; setState('disconnected'); log('Disconnected','#fca5a5');
    if (dumping){
      // attempt salvage
      if (dumpExpected>0 && dumpBuf.length>=dumpExpected){
        finishDump('complete_before_disconnect');
      } else if (dumpBuf.length>=8){
        var idx=findDl01Header(dumpBuf);
        if (idx!==-1 && dumpBuf.length>=idx+8){
          var off=idx+4;
          var sz=dumpBuf[off]|(dumpBuf[off+1]<<8)|(dumpBuf[off+2]<<16)|(dumpBuf[off+3]<<24);
          var need=idx+8+sz;
          if (dumpBuf.length>=need){
            dumpBuf=dumpBuf.slice(idx,need);
            dumpExpected=need;
            finishDump('salvaged_after_disconnect');
          } else {
            log('Partial dump kept ('+dumpBuf.length+'/'+need+').','#fde68a');
          }
        }
      }
      dumping=false;
    }
  }
  function onDisconnected(){ uiDisconnected(); }

  /* ================= SEND CMDS ================= */
  function sendCmd(s){
    if (!rxChar) return Promise.resolve();
    var enc=new TextEncoder();
    var data=enc.encode(s + '\n');
    var i=0;
    function step(){
      if (i>=data.length) return Promise.resolve();
      var chunk=data.slice(i, i+200);
      i+=200;
      return rxChar.writeValueWithoutResponse(chunk)
        .then(()=> new Promise(r=>setTimeout(r,6)))
        .then(step);
    }
    return step();
  }

  /* ================= DUMP HANDLING (robust) ================= */
  let useJsonFraming = false;

  function appendDumpData(arr){
    var old=dumpBuf;
    dumpBuf=new Uint8Array(old.length+arr.length);
    dumpBuf.set(old,0);
    dumpBuf.set(arr,old.length);
    dumpGot = dumpBuf.length;
    if (dumpExpected>0) setProgress(dumpGot/dumpExpected);
  }
  function finishDump(reason){
    dumping=false; userAskedDump=false;
    setProgress(1);

    // If JSON framing included DL01 header, great. If not, try to find it and trim.
    var idx=findDl01Header(dumpBuf);
    if (idx!==-1){
      var off=idx+4;
      var sz=dumpBuf[off]|(dumpBuf[off+1]<<8)|(dumpBuf[off+2]<<16)|(dumpBuf[off+3]<<24);
      var need=idx+8+sz;
      if (dumpBuf.length>=need) dumpBuf=dumpBuf.slice(idx,need);
      dumpExpected=need;
    }

    var blob=new Blob([dumpBuf],{type:'application/octet-stream'});
    var url=URL.createObjectURL(blob);
    btnSave.href=url; btnSave.style.display='inline-block';
    var ts=new Date().toISOString().replace(/[:.]/g,'-');
    btnSave.download='throw_'+ts+'.bin';
    log('Dump finished ('+dumpBuf.length+'/'+dumpExpected+') ['+reason+']','#86efac');

    if (autoSave) btnSave.click();
    if (dumpAutoViz) visualizeBytes(dumpBuf).catch(e=>{ vizStatus.textContent='Viz error: '+e; });
  }
  function findDl01Header(b){
    for (var i=0;i<=b.length-4;i++){
      if (b[i]===0x44 && b[i+1]===0x4C && b[i+2]===0x30 && b[i+3]===0x31) return i;
    }
    return -1;
  }

  function onTxNotify(e){
    var v = new Uint8Array(e.target.value.buffer);
    if (dbg()) log('[notify] len='+v.length+' hex='+hexPreview(v), '#94a3b8');

    // Receiving raw bytes (JSON preamble path)
    if (dumping && useJsonFraming){
      appendDumpData(v);
      if (dumpExpected>0 && dumpBuf.length >= dumpExpected){
        var extra = dumpBuf.length - dumpExpected;
        if (extra > 0){
          var tail = dumpBuf.slice(dumpExpected);
          dumpBuf = dumpBuf.slice(0, dumpExpected);
          finishDump('json_exact');
          textBuf += td.decode(tail, {stream:true});
        } else {
          finishDump('json_exact');
        }
      }
      return;
    }

    // Legacy DL01 fallback when user pressed Dump
    if (userAskedDump && !useJsonFraming){
      var concat = new Uint8Array(hdrBuf.length + v.length);
      concat.set(hdrBuf, 0); concat.set(v, hdrBuf.length);
      var idx = findDl01Header(concat);
      if (idx !== -1 && concat.length >= idx+8){
        var off = idx + 4;
        var body = concat[off] | (concat[off+1]<<8) | (concat[off+2]<<16) | (concat[off+3]<<24);
        dumpExpected = 8 + body;               // header + body
        dumpBuf = concat.slice(idx);           // start from header
        dumping = true; userAskedDump=false;   // now in raw stream mode
        log('DL01 header detected. Expecting '+dumpExpected+' bytes','#fde68a');
        hdrBuf = new Uint8Array(0);
        if (dumpBuf.length >= dumpExpected) finishDump('dl01_exact');
        return;
      }
      hdrBuf = concat.slice(Math.max(0, concat.length - 7)); // rolling window
    }

    // Otherwise decode as text and look for JSON lines
    textBuf += td.decode(v, {stream:true});
    processTextBuf();
  }

  function processTextBuf(){
    var pos;
    while ((pos = textBuf.indexOf('\n')) !== -1){
      var raw = textBuf.slice(0, pos);
      textBuf = textBuf.slice(pos+1);
      var line = raw.trim();
      if (!line) continue;

      if (line.charAt(0)==='{' && line.charAt(line.length-1)==='}'){
        try{
          var safe = line.replace(/\bNaN\b/gi,'null').replace(/\b-?Infinity\b/gi,'null');
          var obj = JSON.parse(safe);

          if (obj && obj.type==='dump_begin' && typeof obj.bytes==='number'){
            // New robust framing
            dumping=true; dumpExpected=obj.bytes; dumpGot=0; dumpBuf=new Uint8Array(0);
            useJsonFraming=true; userAskedDump=false; hdrBuf=new Uint8Array(0);
            setProgress(0);
            log('dump_begin: expecting '+dumpExpected+' bytes','#fde68a');
            continue;
          }
          if (obj && obj.type==='dump_done'){ log('dump_done from device.','#86efac'); continue; }

          if (obj && obj.type==='summary'){
            function fmt(x,d){ return (x===null||x===undefined||!isFinite(x))?'—':Number(x).toFixed(d); }
            // We only get apex in current FW summary; leave others to viz recompute
            summaryStatus.textContent = 'Samples '+obj.samples+' · duration '+obj.duration_ms+' ms';
            apexEl.textContent  = fmt(obj.apex_m,2);
            continue;
          }

          // Other JSON (version, ok, err)
          log(line, '#cbd5e1');
          continue;
        }catch(err){
          log('JSON parse error: ' + err, '#fca5a5');
        }
      } else {
        log(line);
      }
    }
  }

  /* ================= Buttons / actions ================= */
  btnPrimary.onclick = doConnect;
  btnDumpViz.onclick = ()=>{ dumpAutoViz=true; startDump(); };
  miDumpOnly.onclick = ()=>{ dumpAutoViz=false; startDump(); };
  miSummary.onclick  = ()=> sendCmd('SUMMARY');
  miErase.onclick    = ()=> sendCmd('ERASE');
  miRearm.onclick    = ()=> sendCmd('REARM');

  btnVizLast.onclick = ()=>{ if (dumpBuf.length){ visualizeBytes(dumpBuf); } else { vizStatus.textContent='No dump in memory yet.'; } };

  let autosave = true;
  miAutosave.onclick = ()=>{
    autosave = !autosave;
    autosaveStateEl.textContent = autosave ? 'On' : 'Off';
  };

  function startDump(){
    btnSave.style.display='none';
    dumping=false; useJsonFraming=false; dumpExpected=0; dumpGot=0; setProgress(0);
    dumpBuf=new Uint8Array(0); userAskedDump=true; hdrBuf=new Uint8Array(0);
    sendCmd('DUMP');
  }

  /* ================= File loader ================= */
  document.getElementById('fileBin').addEventListener('change', function(e){
    var f = e.target.files && e.target.files[0];
    if (!f) return;
    f.arrayBuffer().then(b=>{ visualizeBytes(new Uint8Array(b)); });
  });

  /* ================= Visualization (your original math) ================= */
  var G = 9.80665;
  function fmt(x,d){ return isFinite(x) ? Number(x).toFixed(d) : '—'; }

  function stripHeaderIfAny(bytes){
    if (bytes.length>=8 && bytes[0]===0x44 && bytes[1]===0x4c && bytes[2]===0x30 && bytes[3]===0x31){
      var sz = bytes[4] | (bytes[5]<<8) | (bytes[6]<<16) | (bytes[7]<<24);
      return bytes.slice(8, 8+sz);
    }
    return bytes;
  }
  function parseRecords(buf){
    // LogRec: u32 ms; i16 ax ay az (×100 m/s²); i16 gx gy gz (×10 dps); float pPa
    var rec=4+2*6+4;
    var n=Math.floor(buf.length/rec);
    var ms=new Uint32Array(n);
    var ax=new Float64Array(n), ay=new Float64Array(n), az=new Float64Array(n);
    var gx=new Float64Array(n), gy=new Float64Array(n), gz=new Float64Array(n);
    var p =new Float64Array(n);
    var dv=new DataView(buf.buffer, buf.byteOffset, n*rec);
    var o=0;
    for (var i=0;i<n;i++){
      ms[i]=dv.getUint32(o,true); o+=4;
      ax[i]=dv.getInt16(o,true)/100; o+=2; ay[i]=dv.getInt16(o,true)/100; o+=2; az[i]=dv.getInt16(o,true)/100; o+=2;
      gx[i]=dv.getInt16(o,true)/10;  o+=2; gy[i]=dv.getInt16(o,true)/10;  o+=2; gz[i]=dv.getInt16(o,true)/10;  o+=2; // dps ×10
      p[i]=dv.getFloat32(o,true); o+=4;
    }
    return {ms:ms,ax:ax,ay:ay,az:az,gx:gx,gy:gy,gz:gz,p:p};
  }
  function complementaryRPY(ax,ay,az,gx,gy,gz,dt,tau){
    var n=dt.length, roll=new Float64Array(n), pitch=new Float64Array(n), yaw=new Float64Array(n);
    var gxr=new Float64Array(n), gyr=new Float64Array(n), gzr=new Float64Array(n);
    var i;
    for(i=0;i<n;i++){ gxr[i]=gx[i]*Math.PI/180; gyr[i]=gy[i]*Math.PI/180; gzr[i]=gz[i]*Math.PI/180; }
    roll[0]=Math.atan2(ay[0],az[0]);
    pitch[0]=Math.atan2(-ax[0], Math.hypot(ay[0],az[0]));
    for (i=1;i<n;i++){
      var a=tau/(tau+dt[i]);
      var roll_g = roll[i-1] + gxr[i]*dt[i];
      var pitch_g= pitch[i-1] + gyr[i]*dt[i];
      yaw[i] = yaw[i-1] + gzr[i]*dt[i];
      var roll_a = Math.atan2(ay[i],az[i]);
      var pitch_a= Math.atan2(-ax[i], Math.hypot(ay[i],az[i]));
      roll[i]  = a*roll_g  + (1-a)*roll_a;
      pitch[i] = a*pitch_g + (1-a)*pitch_a;
    }
    return {roll:roll, pitch:pitch, yaw:yaw};
  }
  function rotationMats(roll,pitch,yaw){
    var n=roll.length, R=new Array(n);
    for (var i=0;i<n;i++){
      var cr=Math.cos(roll[i]), sr=Math.sin(roll[i]);
      var cp=Math.cos(pitch[i]), sp=Math.sin(pitch[i]);
      var cy=Math.cos(yaw[i]), sy=Math.sin(yaw[i]);
      R[i]=[
        [cy*cp,          cy*sp*sr - sy*cr,  cy*sp*cr + sy*sr],
        [sy*cp,          sy*sp*sr + cy*cr,  sy*sp*cr - cy*sr],
        [-sp,            cp*sr,             cp*cr]
      ];
    }
    return R;
  }
  function mulMV(M,v){ return [ M[0][0]*v[0]+M[0][1]*v[1]+M[0][2]*v[2], M[1][0]*v[0]+M[1][1]*v[1]+M[1][2]*v[2], M[2][0]*v[0]+M[2][1]*v[1]+M[2][2]*v[2] ]; }
  function detectMotion(a_ms2, g_dps){
    var n=a_ms2.length, mask=new Array(n), i;
    for (i=0;i<n;i++){
      var aN=Math.hypot(a_ms2[i][0],a_ms2[i][1],a_ms2[i][2])/G;
      var gN=Math.hypot(g_dps[i][0],g_dps[i][1],g_dps[i][2]);
      mask[i]=(gN>50)||Math.abs(aN-1)>0.15;
    }
    // smoothing
    var k=9, out=new Array(n);
    for (i=0;i<n;i++){
      var s=0;
      for (var j=-4;j<=4;j++){
        var x=i+j; if (x>=0 && x<n) s += (mask[x]?1:0);
      }
      out[i]=s>4;
    }
    return out;
  }
  function integrateWithEndZero(a,t,move){
    var n=t.length, v=new Array(n), p=new Array(n), i, j;
    for (i=0;i<n;i++){ v[i]=[0,0,0]; p[i]=[0,0,0]; }
    var dt=new Array(n); dt[0]=0; for (i=1;i<n;i++) dt[i]=Math.max(0.001, Math.min(0.05, t[i]-t[i-1]));
    for (i=1;i<n;i++){ for (j=0;j<3;j++){ v[i][j]=v[i-1][j]+a[i][j]*dt[i]; } }
    var any=false; for(i=0;i<move.length;i++){ if(move[i]){ any=true; break; } }
    if (any){
      var i0=move.indexOf(true);
      var i1=move.length-1 - move.slice().reverse().indexOf(true);
      var T=Math.max(t[i1]-t[i0],1e-6);
      var drift=[ v[i1][0]/T, v[i1][1]/T, v[i1][2]/T ];
      for (i=i0;i<=i1;i++){
        var s=t[i]-t[i0];
        for (j=0;j<3;j++){ v[i][j]-=s*drift[j]; }
      }
      for (i=1;i<n;i++){ for (j=0;j<3;j++){ p[i][j]=p[i-1][j]+v[i][j]*dt[i]; } }
      var o=[ p[i0][0], p[i0][1], p[i0][2] ];
      for (i=0;i<n;i++){ for (j=0;j<3;j++){ p[i][j]-=o[j]; } }
    }
    return {v:v, p:p};
  }
  function pickReleaseIndex(t, speed){
    var n=t.length, s=new Array(n);
    var dtAvg=(t[n-1]-t[0])/(Math.max(1,n-1)); if(!isFinite(dtAvg)||dtAvg<=0) dtAvg=0.01;
    var w=Math.max(1, Math.round(0.05/dtAvg)); // ±50 ms
    for (var i=0;i<n;i++){
      var sum=0,c=0;
      for (var j=-w;j<=w;j++){
        var k=i+j; if(k>=0 && k<n){ sum+=speed[k]; c++; }
      }
      s[i]=sum/Math.max(1,c);
    }
    var endT=t[0]+Math.min(0.30, t[t.length-1]-t[0]);
    var endI=n-1; for(var ii=0;ii<n;ii++){ if (t[ii]>=endT){ endI=ii; break; } }
    var mx=-1, mi=0;
    for (var i2=0;i2<=endI;i2++){ if (s[i2]>mx){ mx=s[i2]; mi=i2; } }
    return mi;
  }
  function yawMatrix(deg){ var r=deg*Math.PI/180, c=Math.cos(r), s=Math.sin(r); return [[c,-s,0],[s,c,0],[0,0,1]]; }
  function mulYaw(M,v){ return [ M[0][0]*v[0]+M[0][1]*v[1], M[1][0]*v[0]+M[1][1]*v[1], v[2] ]; }

  function visualizeBytes(rawBytes){
    vizStatus.textContent='Parsing…';
    try{
      var payload = stripHeaderIfAny(new Uint8Array(rawBytes));
      var rec = parseRecords(payload);
      if (!rec.ms.length){ vizStatus.textContent='No samples.'; return; }

      var t = new Array(rec.ms.length); for(var i=0;i<t.length;i++) t[i]=rec.ms[i]/1000;
      var dt=new Array(t.length); dt[0]=0; for (var i=1;i<t.length;i++) dt[i]=Math.max(0.001, Math.min(0.05, t[i]-t[i-1]));

      var rpy = complementaryRPY(rec.ax,rec.ay,rec.az,rec.gx,rec.gy,rec.gz,dt,0.5);
      var R = rotationMats(rpy.roll, rpy.pitch, rpy.yaw);

      var aBody = new Array(rec.ax.length);
      for(i=0;i<aBody.length;i++) aBody[i]=[rec.ax[i],rec.ay[i],rec.az[i]];
      var aWorld = new Array(aBody.length);
      for(i=0;i<aWorld.length;i++) aWorld[i]=mulMV(R[i],aBody[i]);
      var aLin = new Array(aWorld.length);
      for(i=0;i<aLin.length;i++) aLin[i]=[aWorld[i][0],aWorld[i][1],aWorld[i][2]-G];

      var g3=new Array(rec.gx.length);
      for(i=0;i<g3.length;i++) g3[i]=[rec.gx[i],rec.gy[i],rec.gz[i]];

      var move = detectMotion(aBody, g3);
      var ip = integrateWithEndZero(aLin, t, move);
      var v = ip.v, p = ip.p;

      var speed = new Array(v.length);
      for(i=0;i<speed.length;i++) speed[i]=Math.hypot(v[i][0],v[i][1],v[i][2])+1e-12;
      var ir = pickReleaseIndex(t, speed);

      // Baseline pressure → altitude
      var valid = new Array(rec.p.length); for(i=0;i<valid.length;i++) valid[i]=isFinite(rec.p[i])&&rec.p[i]>1;
      var p0=(function(){
        var vv=[], j; for(j=0;j<rec.p.length;j++) if(valid[j]) vv.push(rec.p[j]);
        var n=Math.max(5, Math.floor(vv.length/50)) || 1;
        if (!vv.length) return 101325;
        var sum=0; for(j=0;j<Math.min(n,vv.length);j++) sum+=vv[j];
        return sum/Math.min(n,vv.length);
      })();
      var alt=new Array(rec.p.length);
      for(i=0;i<alt.length;i++) alt[i]=44330*(1.0 - Math.pow((rec.p[i]/100)/(p0/100), 1/5.255));

      // Align yaw with release velocity heading
      var theta = Math.atan2(v[ir][1], v[ir][0])*180/Math.PI;
      var Q = yawMatrix(-theta);
      var pView = new Array(p.length);
      for(i=0;i<p.length;i++) pView[i]=mulYaw(Q,p[i]);

      // KPIs
      function toKmh(s){ return s*3.6; }
      var peakSp = -1; for(i=0;i<speed.length;i++) if (speed[i]>peakSp) peakSp=speed[i];
      var dtAvg=(t[t.length-1]-t[0])/Math.max(1,t.length-1); if(!isFinite(dtAvg)||dtAvg<=0) dtAvg=0.01;
      var w = Math.max(1, Math.round(0.05/dtAvg)); // ±50ms
      var j0=Math.max(0,ir-w), j1=Math.min(speed.length-1, ir+w);
      var releaseSp=0; for(i=j0;i<=j1;i++) releaseSp+=speed[i]; releaseSp/=Math.max(1,(j1-j0+1));
      var gmag=0; for(i=j0;i<=j1;i++){ gmag+=Math.hypot(rec.gx[i],rec.gy[i],rec.gz[i]); } gmag/=Math.max(1,(j1-j0+1));
      var spinRpm = gmag/6; // dps → rpm
      var hyzerDeg = -rpy.roll[ir]*180/Math.PI;
      var noseDeg  =  rpy.pitch[ir]*180/Math.PI;
      var dx=p[p.length-1][0]-p[0][0], dy=p[p.length-1][1]-p[0][1];
      var carry=Math.hypot(dx,dy);
      var mx=-1; for(i=0;i<alt.length;i++) if (alt[i]>mx) mx=alt[i];
      var apex = (mx - alt[0]) || 0;
      var hang  = t[t.length-1] - t[0];

      // Apply to UI
      apexEl.textContent  = fmt(apex,2);
      carryEl.textContent = fmt(carry,1);
      vrelEl.textContent  = fmt(toKmh(releaseSp),1);
      vpeakEl.textContent = fmt(toKmh(peakSp),1);
      spinEl.textContent  = fmt(spinRpm,0);
      hangEl.textContent  = fmt(hang,2);
      hyzerEl.textContent = fmt(hyzerDeg,1);
      noseEl.textContent  = fmt(noseDeg,1);

      vizStatus.textContent='Rendering…';
      var xs=new Array(pView.length), ys=new Array(pView.length), zs=new Array(pView.length);
      for(i=0;i<pView.length;i++){ xs[i]=pView[i][0]; ys[i]=pView[i][1]; zs[i]=pView[i][2]; }
      function rng(a){ var lo=Infinity, hi=-Infinity, k; for(k=0;k<a.length;k++){ if(a[k]<lo) lo=a[k]; if(a[k]>hi) hi=a[k]; } return (hi>lo)?[lo,hi]:[-1,1]; }

      var data = [
        {type:'scatter3d', mode:'lines', x:xs, y:ys, z:zs, line:{width:6}, name:'This throw'},
        {type:'scatter3d', mode:'markers', x:[xs[ir]], y:[ys[ir]], z:[zs[ir]], marker:{size:6,symbol:'diamond'}, name:'Release'},
        {type:'scatter3d', mode:'markers', x:[xs[xs.length-1]], y:[ys[ys.length-1]], z:[zs[zs.length-1]], marker:{size:6,symbol:'x'}, name:'End'}
      ];
      Plotly.newPlot(vizDiv, data, {
        scene:{xaxis:{title:'X (m)',range:rng(xs)}, yaxis:{title:'Y (m)',range:rng(ys)}, zaxis:{title:'Z (m)',range:rng(zs)}, aspectmode:'data'},
        margin:{l:0,r:0,t:30,b:0},
        title:'Flight — release '+fmt(toKmh(releaseSp),1)+' km/h · peak '+fmt(toKmh(peakSp),1)+' km/h · carry '+fmt(carry,1)+' m · apex '+fmt(apex,1)+' m'
      }, {responsive:true}).then(function(){ vizStatus.textContent='Done.'; });

      // CSV export
      var rows=["t_s,x_m,y_m,z_m,vx,vy,vz,axw,ayw,azw,alt_m,roll_deg,pitch_deg,yaw_deg"];
      for (i=0;i<t.length;i++){
        rows.push([t[i], pView[i][0], pView[i][1], pView[i][2],
                   v[i][0], v[i][1], v[i][2],
                   aWorld[i][0], aWorld[i][1], aWorld[i][2],
                   alt[i], rpy.roll[i]*180/Math.PI, rpy.pitch[i]*180/Math.PI, rpy.yaw[i]*180/Math.PI].join(","));
      }
      var csvBlob=new Blob([rows.join("\n")], {type:'text/csv'});
      btnCSV.href=URL.createObjectURL(csvBlob);
      btnCSV.style.display='inline-block';
      btnPNG.onclick=function(){
        Plotly.toImage(vizDiv,{format:'png',width:1400,height:820,scale:2})
          .then(function(url){ btnPNG.href=url; });
      };
      btnPNG.style.display='inline-block';
    }catch(e){
      vizStatus.textContent='Viz error: '+e;
      throw e;
    }
  }

  // Hook file buttons in the action bar
  document.getElementById('miLoadBin').onclick = ()=> fileBin.click();
  document.getElementById('miCSV').onclick     = ()=> btnCSV.click();
  document.getElementById('miPNG').onclick     = ()=> btnPNG.click();

  // Keyboard shortcuts
  window.addEventListener('keydown', (e)=>{
    if(e.target && (e.target.tagName==='INPUT' || e.target.tagName==='TEXTAREA')) return;
    if(e.key==='c' || e.key==='C'){ if(!connected) doConnect(); else doDisconnect(); }
    if(e.key==='d' || e.key==='D'){ dumpAutoViz=true; startDump(); }
    if(e.key==='s' || e.key==='S'){ sendCmd('SUMMARY'); }
    if(e.key==='r' || e.key==='R'){ sendCmd('REARM'); }
  });

  // Initial state
  setState('disconnected');
})();
</script>
</body>
</html>
